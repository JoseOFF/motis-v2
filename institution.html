<!DOCTYPE html>
<html lang="es">
<head>
    <title>Reconocimiento de notas</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="assets/img/logo.png" type="image/png">

    <!-- LibrerÃ­as y hojas de estilo -->
    <script src="js/sweet-alert.min.js"></script>
    <link rel="stylesheet" href="css/sweet-alert.css">
    <link rel="stylesheet" href="css/material-design-iconic-font.min.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- jQuery con fallback -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>

    <!-- Otros scripts -->
    <script src="js/modernizr.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="js/main.js"></script>

    <!-- Estilos personalizados -->
    <style>
        .note-container {
            background-color: #333;
            border-radius: 15px;
            padding: 30px;
            margin-top: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            width: 80%;
            max-width: 700px;
            text-align: center;
            transition: transform 0.2s ease-in-out;
            margin-left: auto;
            margin-right: auto;
        }

        .note-container:hover {
            transform: scale(1.05);
        }

        h1 {
            font-size: 2.5em;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        #note {
            font-size: 4em;
            font-weight: bold;
            color: #76d7c4;
            transition: transform 0.3s ease-in-out;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:active {
            transform: scale(0.98);
        }

        .animate {
            animation: pulse 0.3s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        #waveform {
            width: 100%;
            height: 150px;
            background-color: #000;
            border-radius: 10px;
            margin-top: 20px;
        }

        p {
            color: #ffffff;
        }
    </style>
</head>
    <!-- MenÃº lateral -->
    <!-- CÃ³digo del menÃº lateral, encabezado y navegaciÃ³n superior -->
     <body>
    <div class="navbar-lateral full-reset"> <!-- Contenedor del menÃº lateral izquierdo -->
        <div class="visible-xs font-movile-menu mobile-menu-button"></div> <!-- BotÃ³n del menÃº en vista mÃ³vil -->

        <div class="full-reset container-menu-movile nav-lateral-scroll"> <!-- Contenedor desplazable del menÃº lateral -->

            <div class="logo full-reset all-tittles"> <!-- Logo del menÃº -->
                <i class="visible-xs zmdi zmdi-close pull-left mobile-menu-button" 
                   style="line-height: 55px; cursor: pointer; padding: 0 10px; margin-left: 7px;"></i> <!-- BotÃ³n cerrar en mÃ³viles -->
                PlayBass! <!-- Texto del logo -->
            </div>

            <div class="nav-lateral-divider full-reset"></div> <!-- LÃ­nea divisoria -->

            <div class="full-reset" style="padding: 10px 0; color:#fff;"> <!-- SecciÃ³n del logo visual -->
                <figure>
                    <img src="assets/img/logo.png" alt="Biblioteca" class="img-responsive center-box" style="width:55%;"> <!-- Logo -->
                </figure>
                <p class="text-center" style="padding-top: 15px;">Menu de PlayBass!</p> <!-- TÃ­tulo del menÃº -->
            </div>

            <div class="nav-lateral-divider full-reset"></div> <!-- LÃ­nea divisoria -->

            <div class="full-reset nav-lateral-list-menu"> <!-- Contenedor del listado de menÃº -->
                <ul class="list-unstyled"> <!-- Lista sin estilo -->

                    <li><a href="home.html"><i class="zmdi zmdi-home zmdi-hc-fw"></i>&nbsp;&nbsp; Inicio</a></li> <!-- Enlace a inicio -->

                    <li> <!-- SecciÃ³n: Aprende + -->
                        <div class="dropdown-menu-button">
                            <i class="zmdi zmdi-assignment-o zmdi-hc-fw"></i>&nbsp;&nbsp; Aprende +
                            <i class="zmdi zmdi-chevron-down pull-right zmdi-hc-fw icon-sub-menu"></i> <!-- Flecha desplegable -->
                        </div>
                        <ul class="list-unstyled">
                            <li><a href="https://www.songsterr.com/"><i class="zmdi zmdi-book zmdi-hc-fw"></i>&nbsp;&nbsp; Biblioteca de canciones</a></li>
                            <li><a href="catalog.html"><i class="zmdi zmdi-bookmark-outline zmdi-hc-fw"></i>&nbsp;&nbsp; Eres nuevo en esto?</a></li>
                        </ul>
                    </li>

                    <li> <!-- SecciÃ³n: Servicios -->
                        <div class="dropdown-menu-button">
                            <i class="zmdi zmdi-case zmdi-hc-fw"></i>&nbsp;&nbsp; Servicios 
                            <i class="zmdi zmdi-chevron-down pull-right zmdi-hc-fw icon-sub-menu"></i>
                        </div>
                        <ul class="list-unstyled">
                            <li><a href="institution.html"><i class="zmdi zmdi-balance zmdi-hc-fw"></i>&nbsp;&nbsp; Reconocimiento de notas</a></li>
                            <li><a href="provider.html"><i class="zmdi zmdi-truck zmdi-hc-fw"></i>&nbsp;&nbsp; Simulador de bajo</a></li>
                        </ul>
                    </li>

                    <li> <!-- SecciÃ³n: Foro y comunidad -->
                        <div class="dropdown-menu-button">
                            <i class="zmdi zmdi-account-add zmdi-hc-fw"></i>&nbsp;&nbsp; Foro y comunidad 
                            <i class="zmdi zmdi-chevron-down pull-right zmdi-hc-fw icon-sub-menu"></i>
                        </div>
                        <ul class="list-unstyled">
                            <li><a href="vibass.html"><i class="zmdi zmdi-face zmdi-hc-fw"></i>&nbsp;&nbsp; ViBass</a></li>
                        </ul>
                    </li>

                    <li><a href="advancesettings.html"><i class="zmdi zmdi-wrench zmdi-hc-fw"></i>&nbsp;&nbsp; Configuraciones avanzadas</a></li> <!-- ConfiguraciÃ³n -->
                </ul>
            </div>
        </div>
    </div>

    <div class="content-page-container full-reset custom-scroll-containers"> <!-- Contenedor principal de contenido -->

        <nav class="navbar-user-top full-reset"> <!-- Barra superior del usuario -->
            <ul class="list-unstyled full-reset">

                <figure>
                   <img src="assets/img/user01.png" alt="user-picture" class="img-responsive img-circle center-box"> <!-- Foto del usuario -->
                </figure>

                <li style="color:#fff; cursor:default;">
                    <span class="all-tittles">Admin Name</span> <!-- Nombre del usuario -->
                </li>

                <li class="tooltips-general exit-system-button" data-href="index.html" data-placement="bottom" title="Salir del sistema">
                    <i class="zmdi zmdi-power"></i> <!-- Icono para cerrar sesiÃ³n -->
                </li>

                <li class="tooltips-general btn-help" data-placement="bottom" title="Ayuda">
                    <i class="zmdi zmdi-help-outline zmdi-hc-fw"></i> <!-- BotÃ³n de ayuda -->
                </li>

                <li class="mobile-menu-button visible-xs" style="float: left !important;">
                    <i class="zmdi zmdi-menu"></i> <!-- BotÃ³n para abrir menÃº lateral en mÃ³viles -->
                </li>

                <li class="desktop-menu-button hidden-xs" style="float: left !important;">
                    <i class="zmdi zmdi-swap"></i> <!-- BotÃ³n para alternar el menÃº en escritorio -->
                </li>
            </ul>
        </nav>

        <div class="container"> <!-- Contenedor del contenido principal -->
            <div class="page-header">
                <h1 class="all-tittles">Reconocimientode notas <small>Para bajo</small></h1> <!-- TÃ­tulo de la pÃ¡gina -->
            </div>
        </div>
     <section class="note-container">
        <h1 id="mode-title">Nota detectada: <span id="note">ðŸŽµ</span></h1>
        <div class="tuner-controls">
            <button onclick="toggleMode()" id="mode-button">Cambiar a Afinador</button>
            <button onclick="start()">Comenzar</button>
            <button onclick="stop()">Detener</button>
        </div>

        <div id="tuner-section" style="display: none;">
            <h2>Afinador de Bajo (5 cuerdas)</h2>
            <div class="string-buttons">
                <button onclick="selectString('E1', 41.20)">4 Mi (E)</button>
                <button onclick="selectString('A1', 55.00)">3 La (A)</button>
                <button onclick="selectString('D2', 73.42)">2 Re (D)</button>
                <button onclick="selectString('G2', 98.00)">1 Sol (G)</button>
            </div>
            <p>Cuerda seleccionada: <strong id="selected-string">Ninguna</strong></p>
            <p>Diferencia: <strong id="deviation">-- Hz</strong></p>
            <p id="tuning-status">ðŸŽµ Esperando entrada...</p>
        </div>

        <canvas id="waveform" width="800" height="200"></canvas>

        <!-- Barra de precisiÃ³n -->
        <div id="precision-bar" style="display:none; margin-top: 10px;">
            <div style="position: relative; height: 20px; background: #ddd; border-radius: 10px;">
                <div id="indicator" style="position: absolute; top: 0; width: 2px; height: 100%; background: red; left: 50%;"></div>
            </div>
            <p style="text-align:center; margin-top:5px;" id="range-feedback">ðŸŽ¯ Ajusta hasta estar en el centro</p>
        </div>

<!--JavaScript-->
        <!-- Asistente botpress -->
        <div id="feed"></div>
        <script src="https://cdn.botpress.cloud/webchat/v2.4/inject.js"></script>
        <script src="https://files.bpcontent.cloud/2025/05/22/22/20250522223936-92WAM02X.js"></script>
    </section>

    </section>

<script>
  // Variables principales para audio, canvas y control de estado
  let audioContext, analyser, dataArray, bufferLength, stream;
  let isRunning = false;

  const canvas = document.getElementById("waveform");
  const canvasContext = canvas.getContext("2d");

  let mode = "note"; // Puede ser "note" o "tuner"
  let selectedFreq = null;
  let selectedStringName = "";

  // Cambia entre los modos: analizador de notas <-> afinador
  function toggleMode() {
    if (mode === "note") {
      mode = "tuner";
      document.getElementById("mode-title").textContent = "Afinador de Bajo";
      document.getElementById("mode-button").textContent = "Cambiar a Analizador de Notas";
      document.getElementById("tuner-section").style.display = "block";
      document.getElementById("precision-bar").style.display = "block";
    } else {
      mode = "note";
      document.getElementById("mode-title").innerHTML = 'Nota detectada: <span id="note">ðŸŽµ</span>';
      document.getElementById("mode-button").textContent = "Cambiar a Afinador";
      document.getElementById("tuner-section").style.display = "none";
      document.getElementById("precision-bar").style.display = "none";
    }
  }

  // Selecciona una cuerda para afinar (afinador)
  function selectString(name, freq) {
    selectedFreq = freq;
    selectedStringName = name;
    document.getElementById("selected-string").textContent = name;
  }

  // Inicia el reconocimiento de audio
  function start() {
    if (isRunning) return;

    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(userStream => {
        stream = userStream;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);
        analyser.fftSize = 2048;

        bufferLength = analyser.fftSize;
        dataArray = new Float32Array(bufferLength);

        isRunning = true;
        detectPitch(); // Inicia la detecciÃ³n continua
      })
      .catch(err => alert("Error al acceder al micrÃ³fono: " + err));
  }

  // Detiene la entrada de audio y limpia interfaz
  function stop() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    isRunning = false;
    clearCanvas();
    document.getElementById("note").textContent = "ðŸŽµ";
    document.getElementById("tuning-status").textContent = "ðŸŽµ Esperando entrada...";
    document.getElementById("deviation").textContent = "-- Hz";
  }

  // DetecciÃ³n de tono principal
  function detectPitch() {
    if (!isRunning) return;

    analyser.getFloatTimeDomainData(dataArray);
    const frequency = autoCorrelate(dataArray, audioContext.sampleRate);

    if (frequency !== -1) {
      if (mode === "note") {
        // En modo "nota" simplemente mostramos la nota calculada
        const note = frequencyToNote(frequency);
        document.getElementById("note").textContent = note;
      } else if (mode === "tuner" && selectedFreq) {
        // En modo "afinador" comparamos con frecuencia objetivo
        const deviation = (frequency - selectedFreq).toFixed(2);
        const maxDeviation = 50;
        const deviationValue = frequency - selectedFreq;

        // Porcentaje para posicionar el indicador (de -50 a +50 Hz)
        let percent = Math.max(Math.min((deviationValue + maxDeviation) / (2 * maxDeviation), 1), 0);
        let positionPercent = percent * 100;
        const indicator = document.getElementById("indicator");
        indicator.style.left = `${positionPercent}%`;

        // Colores de precisiÃ³n y mensaje
        const feedback = document.getElementById("range-feedback");
        if (Math.abs(deviationValue) < 1) {
          indicator.style.background = "#2ecc71";
          feedback.textContent = "âœ… Â¡Perfecto! Nota afinada.";
        } else if (Math.abs(deviationValue) < 5) {
          indicator.style.background = "#f39c12";
          feedback.textContent = "ðŸŽ¯ Casi... Ajusta un poco mÃ¡s.";
        } else {
          indicator.style.background = "#e74c3c";
          feedback.textContent = "âŒ Muy desajustada. Sigue afinando.";
        }

        document.getElementById("deviation").textContent = `${deviation} Hz`;

        if (Math.abs(deviationValue) < 1) {
          document.getElementById("tuning-status").textContent = `âœ… ${selectedStringName} afinada`;
          document.getElementById("tuning-status").style.color = "#2ecc71";
        } else {
          document.getElementById("tuning-status").textContent = `ðŸŽ¯ Ajusta: estÃ¡s en ${frequency.toFixed(2)} Hz`;
          document.getElementById("tuning-status").style.color = "#e67e22";
        }
      }
    }

    drawWaveform(); // Actualiza grÃ¡fico de forma de onda
    requestAnimationFrame(detectPitch); // Loop continuo
  }

  // Algoritmo de autocorrelaciÃ³n para detectar la frecuencia fundamental
  function autoCorrelate(buffer, sampleRate) {
    const SIZE = buffer.length;
    const MAX_SAMPLES = Math.floor(SIZE / 2);
    let bestOffset = -1;
    let bestCorrelation = 0;
    let rms = 0;

    for (let i = 0; i < SIZE; i++) {
      const val = buffer[i];
      rms += val * val;
    }
    rms = Math.sqrt(rms / SIZE);
    if (rms < 0.01) return -1; // SeÃ±al demasiado dÃ©bil

    let lastCorrelation = 1;
    for (let offset = 1; offset < MAX_SAMPLES; offset++) {
      let correlation = 0;
      for (let i = 0; i < MAX_SAMPLES; i++) {
        correlation += Math.abs(buffer[i] - buffer[i + offset]);
      }
      correlation = 1 - (correlation / MAX_SAMPLES);

      if (correlation > 0.9 && correlation > lastCorrelation) {
        bestCorrelation = correlation;
        bestOffset = offset;
      }
      lastCorrelation = correlation;
    }

    return bestCorrelation > 0.01 ? sampleRate / bestOffset : -1;
  }

  // Convierte una frecuencia a su nota musical mÃ¡s cercana (ej. 110Hz -> La2)
  function frequencyToNote(freq) {
    const noteStrings = ["Do", "Doâ™¯", "Re", "Reâ™¯", "Mi", "Fa", "Faâ™¯", "Sol", "Solâ™¯", "La", "Laâ™¯", "Si"];
    const A4 = 440;
    const noteNumber = 12 * (Math.log(freq / A4) / Math.log(2));
    const noteIndex = Math.round(noteNumber) + 69;
    const noteName = noteStrings[noteIndex % 12];
    const octave = Math.floor(noteIndex / 12) - 1;
    return `${noteName}${octave}`;
  }

  // Dibuja la forma de onda en el canvas (visualizador)
  function drawWaveform() {
    canvasContext.clearRect(0, 0, canvas.width, canvas.height);
    const width = canvas.width;
    const height = canvas.height;
    const step = Math.floor(dataArray.length / width);
    const amp = height / 2;

    canvasContext.beginPath();
    for (let i = 0; i < width; i++) {
      const sample = dataArray[i * step];
      const y = (sample * amp) + amp;
      if (i === 0) {
        canvasContext.moveTo(i, y);
      } else {
        canvasContext.lineTo(i, y);
      }
    }
    canvasContext.strokeStyle = "#76d7c4";
    canvasContext.stroke();
  }

  // Limpia el canvas
  function clearCanvas() {
    canvasContext.clearRect(0, 0, canvas.width, canvas.height);
  }
</script>
</body>

   <!--Footer de la pagina -->
  <div class="modal fade" tabindex="-1" role="dialog" id="ModalHelp">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title text-center all-tittles">ayuda del sistema</h4>
          </div>
          <div class="modal-body">
              Lorem ipsum dolor sit amet, consectetur adipisicing elit. Inventore dignissimos qui molestias ipsum officiis unde aliquid consequatur, accusamus delectus asperiores sunt. Quibusdam veniam ipsa accusamus error. Animi mollitia corporis iusto.
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal"><i class="zmdi zmdi-thumb-up"></i> &nbsp; De acuerdo</button>
          </div>
      </div>
    </div>
  </div>
  <footer class="footer full-reset">
      <div class="container-fluid">
          <div class="row">
              <div class="col-xs-12 col-sm-6">
                  <h4 class="all-tittles">Acerca de</h4>
                  <p>
                      PlayBass es una plataforma para aprender y practicar el bajo elÃ©ctrico. Ofrece herramientas interactivas, una biblioteca de canciones y una comunidad donde puedes compartir tu progreso y conectar con otros mÃºsicos.
                  </p>
              </div>
              <div class="col-xs-12 col-sm-6">
                  <h4 class="all-tittles">Desarrollador</h4>
                  <ul class="list-unstyled">
                      <li><i class="zmdi zmdi-check zmdi-hc-fw"></i>&nbsp; Â© Team Wicho<i class="zmdi zmdi-facebook zmdi-hc-fw footer-social"></i><i class="zmdi zmdi-twitter zmdi-hc-fw footer-social"></i></li>
                  </ul>
              </div>
          </div>
      </div>
      <div class="footer-copyright full-reset all-tittles">Â© Team Wicho</div>
  </footer>
</div>
</body>
</html>